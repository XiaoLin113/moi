<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H√≥a ƒë∆°n nh·∫≠n chuy·ªÉn kho·∫£n h·ªô ti·ªÅn ƒëi·ªán</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --blue:#2b8cff;
      --green:#28a745;
      --card:#fff;
    }
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{background:#f0f2f7;margin:0;padding:20px;display:flex;justify-content:center}
    .wrap{width:100%;max-width:480px;background:var(--card);border-radius:20px;padding:22px;box-shadow:0 6px 18px rgba(20,20,30,0.1)}
    label{width:130px;font-weight:600;color:#111}
    input[type=text],input[type=number]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #ccc;font-size:16px}
    .form-group{display:flex;gap:10px;align-items:center;margin-top:14px}
    .btn-primary{background:var(--blue);color:#fff;border:none;padding:12px 16px;border-radius:10px;font-weight:700;font-size:16px;cursor:pointer;box-shadow:0 4px 10px rgba(43,140,255,0.3)}
    .small-btn{width:46px;height:46px;border-radius:10px;border:none;background:var(--blue);color:#fff;font-size:20px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .btn-green{width:100%;background:var(--green);color:#fff;border:none;padding:12px;font-weight:700;border-radius:10px;font-size:17px;cursor:pointer;margin-top:16px}
    .invoice{margin-top:16px;border-radius:14px;border:2px solid #111;padding:16px;min-height:140px;background:#fff;font-size:16px;line-height:1.5;position:relative}
    .invoice-header{text-align:center;font-weight:800;font-size:18px;margin-bottom:10px;text-transform:uppercase}
    .invoice-date{position:absolute;top:8px;right:12px;font-size:13px;color:#555}
    .actions{display:flex;gap:12px;margin-top:14px}
    .actions .btn{flex:1;padding:12px;border-radius:12px;border:2px solid var(--blue);background:#fff;color:var(--blue);font-weight:700;cursor:pointer}
    .actions .btn.primary{background:var(--blue);color:#fff}
    .history{margin-top:14px}
    .history-list{max-height:160px;overflow:auto;border:1px solid #eee;background:#fff;padding:10px;border-radius:10px;font-size:14px}
    #qr-reader{width:100%;margin-top:10px;border-radius:10px;overflow:hidden;display:none}
    @media print{body *{visibility:hidden}#invoice,#invoice *{visibility:visible}#invoice{position:absolute;left:0;top:0;width:100%}}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="text-align:center;margin-bottom:10px;">
      <button class="btn-primary" id="btnLoad">ƒê·∫©y d·ªØ li·ªáu</button>
    </div>

    <div class="form-group"><label>Ng∆∞·ªùi thu ti·ªÅn</label><input id="nguoiThu" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu"></div>
    <div class="form-group">
      <label>M√£ kh√°ch h√†ng</label>
      <input id="maKH" list="danhSachKH" placeholder="(t√¨m ki·∫øm)">
      <button class="small-btn" id="btnSearch">üîç</button>
      <button class="small-btn" id="btnScan">üì∑</button>
    </div>
    <div class="form-group"><label>S·ªë ti·ªÅn</label><input id="soTien" type="number"></div>
    <div class="form-group"><label>T√™n KH</label><input id="tenKH" type="text" readonly></div>

    <button class="btn-green" id="btnPrint">In h√≥a ƒë∆°n</button>

    <div id="invoice" class="invoice">
      <div class="invoice-date" id="ngayIn"></div>
      <div class="invoice-header">H√ìA ƒê∆†N NH·∫¨N CHUY·ªÇN KHO·∫¢N H·ªò TI·ªÄN ƒêI·ªÜN</div>
      <div id="invoiceContent">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnConfirm">X√°c nh·∫≠n ƒë√£ thu</button>
    </div>

    <div id="qr-reader"></div>
    <div class="history">
      <div style="font-weight:700;margin-bottom:6px">L·ªãch s·ª≠ in</div>
      <div class="history-list" id="historyList"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button style="flex:1;background:#f3f3f3;border:none;border-radius:10px;padding:10px" id="btnExportIn">Xu·∫•t l·ªãch s·ª≠ in</button>
      <button style="flex:1;background:#f3f3f3;border:none;border-radius:10px;padding:10px" id="btnExportThu">Xu·∫•t l·ªãch s·ª≠ thu</button>
    </div>
    <button style="width:100%;background:#f3f3f3;border:none;border-radius:10px;padding:10px;margin-top:8px" id="btnExportExcel">Xu·∫•t Excel</button>
    <button style="width:100%;background:#fff;border:1px solid #eee;border-radius:10px;padding:10px;margin-top:8px" id="btnClear">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>

    <input id="fileInput" type="file" accept=".xlsx" style="display:none">
    <datalist id="danhSachKH"></datalist>
  </div>

<script>
let duLieu=[],lichSuIn=JSON.parse(localStorage.getItem('lichSuIn')||'[]'),lichSuThu=JSON.parse(localStorage.getItem('lichSuThu')||'[]');
let html5QrcodeScanner=null,scannerRunning=false;
const maKHInput=document.getElementById('maKH'),tenKHInput=document.getElementById('tenKH'),soTienInput=document.getElementById('soTien'),nguoiThuInput=document.getElementById('nguoiThu');
const invoiceContent=document.getElementById('invoiceContent'),historyList=document.getElementById('historyList'),btnLoad=document.getElementById('btnLoad'),fileInput=document.getElementById('fileInput');
const btnSearch=document.getElementById('btnSearch'),btnScan=document.getElementById('btnScan'),btnPrint=document.getElementById('btnPrint'),btnConfirm=document.getElementById('btnConfirm');
const btnExportIn=document.getElementById('btnExportIn'),btnExportThu=document.getElementById('btnExportThu'),btnExportExcel=document.getElementById('btnExportExcel'),btnClear=document.getElementById('btnClear');
const qrReaderDiv=document.getElementById('qr-reader'),ngayIn=document.getElementById('ngayIn');

function capNhatNgayIn(){const now=new Date();ngayIn.textContent='Ng√†y in: '+now.toLocaleDateString('vi-VN')+' ‚Äì '+now.toTimeString().split(' ')[0];}
function formatVND(n){return Number(n).toLocaleString('vi-VN')+' ‚Ç´';}
function capNhatLichSu(){historyList.innerHTML='';lichSuIn.forEach(i=>{const d=document.createElement('div');d.textContent=`(${i.thoiGian}) ${i.maKH} - ${i.tenKH}: ${formatVND(i.soTien)}`;historyList.appendChild(d);});}
capNhatNgayIn();capNhatLichSu();
btnLoad.onclick=()=>fileInput.click();fileInput.onchange=docFileExcel;
function docFileExcel(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(ev)=>{const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'});const sh=wb.Sheets[wb.SheetNames[0]];
duLieu=XLSX.utils.sheet_to_json(sh).map(r=>({MA_KHTT:String(r.MA_KHTT||r['M√£ KH']||'').trim().toUpperCase(),TEN_KHTT:String(r.TEN_KHTT||r['T√™n']||'').trim(),TONG_NOP:String(r.TONG_NOP||r['S·ªë ti·ªÅn']||'').replace(/[^0-9]/g,'')}));
const dl=document.getElementById('danhSachKH');dl.innerHTML='';duLieu.forEach(r=>{const o=document.createElement('option');o.value=r.MA_KHTT;dl.appendChild(o)});alert('ƒê·∫©y d·ªØ li·ªáu th√†nh c√¥ng!');};r.readAsArrayBuffer(f);}
btnSearch.onclick=timKiemMaKH;
function timKiemMaKH(){const ma=maKHInput.value.trim().toUpperCase();const kh=duLieu.find(r=>r.MA_KHTT===ma);if(!kh){invoiceContent.innerText='[Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng]';return;}
tenKHInput.value=kh.TEN_KHTT;soTienInput.value=kh.TONG_NOP;const sanLuong=tinhSanLuongTuSoTien(Number(kh.TONG_NOP));hienThiHoaDon(kh.MA_KHTT,kh.TEN_KHTT,Number(kh.TONG_NOP),sanLuong);}
function tinhSanLuongTuSoTien(soTien){const bac=[{s:55,g:1984},{s:52,g:2050},{s:103,g:2380},{s:103,g:2998},{s:103,g:3350},{s:287,g:3460}];let tong=0,tien=soTien;for(let i of bac){const tb=i.s*i.g;if(tien>=tb){tong+=i.s;tien-=tb;}else{tong+=Math.floor(tien/i.g);break;}}return tong;}
function hienThiHoaDon(ma,ten,soTien,sanLuong){capNhatNgayIn();const nguoi=nguoiThuInput.value||'-',phi=2000,tong=Number(soTien)+phi;const now=new Date(),tg=`Ng√†y ${now.toLocaleDateString('vi-VN')}, Gi·ªù ${now.toTimeString().split(' ')[0]}`;
invoiceContent.innerHTML=`<p><b>M√£ KH:</b> ${ma}</p><p><b>T√™n KH:</b> ${ten}</p><p><b>∆Ø·ªõc s·∫£n l∆∞·ª£ng:</b> ${sanLuong} kWh</p><p><b>Ph√≠:</b> ${formatVND(phi)}</p><p><b>T·ªïng:</b> ${formatVND(tong)}</p><p><b>Ng∆∞·ªùi thu:</b> ${nguoi}</p>
<p style='color:green;font-weight:700;text-align:center'>ƒê√É NH·∫¨N TI·ªÄN</p><p style='text-align:center'>${tg}</p><div id='maQR' style='text-align:center;margin-top:10px;'></div>`;const qrDiv=document.getElementById('maQR');qrDiv.innerHTML='';new QRCode(qrDiv,{text:ma,width:120,height:120});}
btnPrint.onclick=()=>{const ma=maKHInput.value.trim(),ten=tenKHInput.value.trim(),soTien=Number(soTienInput.value||0);if(!ma||!ten||!soTien){alert('Nh·∫≠p ƒë·ªß th√¥ng tin tr∆∞·ªõc khi in!');return;}
const san=tinhSanLuongTuSoTien(soTien);hienThiHoaDon(ma,ten,soTien,san);const tong=soTien+2000,thoiGian=new Date().toLocaleString();lichSuIn.push({maKH:ma,tenKH:ten,soTien:tong,thoiGian});lichSuThu.push({maKH:ma,tenKH:ten,soTien:tong,thoiGian});
localStorage.setItem('lichSuIn',JSON.stringify(lichSuIn));localStorage.setItem('lichSuThu',JSON.stringify(lichSuThu));capNhatLichSu();stopQrScannerIfRunning();const w=window.open('','','width=600,height=800');w.document.write('<html><head><title>In h√≥a ƒë∆°n</title></head><body>'+document.getElementById('invoice').outerHTML+'</body></html>');w.document.close();w.focus();setTimeout(()=>w.print(),500);};
btnConfirm.onclick=()=>{const ma=maKHInput.value.trim(),ten=tenKHInput.value.trim(),soTien=Number(soTienInput.value||0);if(!ma||!ten||!soTien){alert('Thi·∫øu th√¥ng tin');return;}
const tong=soTien+2000,thoiGian=new Date().toLocaleString();lichSuThu.push({maKH:ma,tenKH:ten,soTien:tong,thoiGian});localStorage.setItem('lichSuThu',JSON.stringify(lichSuThu));capNhatLichSu();alert('ƒê√£ l∆∞u');};
function exportCsv(a,f){const h='M√£ KH,T√™n KH,S·ªë ti·ªÅn,Th·ªùi gian\n',r=a.map(i=>`${i.maKH},${i.tenKH},${i.soTien},${i.thoiGian}`).join('\n');const b=new Blob([h+r],{type:'text/csv'});const link=document.createElement('a');link.href=URL.createObjectURL(b);link.download=f;link.click();}
btnExportIn.onclick=()=>exportCsv(lichSuIn,'lich_su_in.csv');btnExportThu.onclick=()=>exportCsv(lichSuThu,'lich_su_thu.csv');btnExportExcel.onclick=()=>exportCsv([...lichSuIn,...lichSuThu],'lich_su_all.csv');
btnClear.onclick=()=>{if(confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠?')){lichSuIn=[];lichSuThu=[];localStorage.removeItem('lichSuIn');localStorage.removeItem('lichSuThu');capNhatLichSu();}};
btnScan.onclick=startQrScanner;
function startQrScanner(){if(scannerRunning)return stopQrScannerIfRunning();qrReaderDiv.style.display='block';Html5Qrcode.getCameras().then(c=>{if(!c||c.length===0){alert('‚ö†Ô∏è Vui l√≤ng c·∫•p quy·ªÅn camera ƒë·ªÉ qu√©t m√£ QR!');return;}
html5QrcodeScanner=new Html5Qrcode('qr-reader');const camId=c[0].id;html5QrcodeScanner.start({deviceId:{exact:camId}},{fps:10,qrbox:{width:250,height:250}},text=>{maKHInput.value=text.trim();timKiemMaKH();stopQrScannerIfRunning();});scannerRunning=true;}).catch(()=>alert('‚ö†Ô∏è Vui l√≤ng c·∫•p quy·ªÅn camera ƒë·ªÉ qu√©t m√£ QR!'));}
function stopQrScannerIfRunning(){if(html5QrcodeScanner&&scannerRunning){html5QrcodeScanner.stop().then(()=>{html5QrcodeScanner.clear();html5QrcodeScanner=null;scannerRunning=false;qrReaderDiv.style.display='none';});}}
window.onbeforeunload=()=>stopQrScannerIfRunning();
</script>
</body>
</html>
