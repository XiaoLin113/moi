<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H√≥a ƒë∆°n nh·∫≠n chuy·ªÉn kho·∫£n h·ªô ti·ªÅn ƒëi·ªán</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --blue: #2b8cff;
      --green: #28a745;
    }
    * {
      box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
    }
    body {
      background: #f0f2f7;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    .wrap {
      width: 100%;
      max-width: 480px;
      background: #fff;
      border-radius: 20px;
      padding: 22px;
    }
    label {
      width: 130px;
      font-weight: 600;
      color: #111;
    }
    input[type=text], input[type=number] {
      flex: 1;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    .form-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 14px;
    }
    .btn-primary {
      background: var(--blue);
      color: #fff;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
    }
    .half-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .half-buttons button {
      flex: 1;
      background: var(--blue);
      color: white;
      border: none;
      padding: 14px 0;
      border-radius: 10px;
      font-size: 18px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-green {
      width: 100%;
      background: var(--green);
      color: #fff;
      border: none;
      padding: 14px;
      font-weight: 700;
      border-radius: 10px;
      font-size: 17px;
      cursor: pointer;
      margin-top: 16px;
    }
    .invoice {
      margin-top: 16px;
      border-radius: 14px;
      border: 2px solid #111;
      padding: 16px;
      background: #fff;
      font-size: 16px;
      line-height: 1.5;
      position: relative;
    }
    .invoice-header {
      text-align: center;
      font-weight: 800;
      font-size: 18px;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .invoice-date {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 13px;
      color: #555;
    }
    #qr-reader {
      width: 100%;
      margin-top: 10px;
      border-radius: 10px;
      overflow: hidden;
      display: none;
    }
    @media print {
      body * { visibility: hidden; }
      #invoice, #invoice * { visibility: visible; }
      #invoice { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="form-group">
      <label>Ng∆∞·ªùi thu ti·ªÅn</label>
      <input id="nguoiThu" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu">
    </div>
    <div class="form-group">
      <label>M√£ kh√°ch h√†ng</label>
      <input id="maKH" list="danhSachKH" placeholder="(t√¨m ki·∫øm)">
    </div>

    <div class="half-buttons">
      <button id="btnSearch">üîç</button>
      <button id="btnScan">üì∑</button>
    </div>

    <div class="form-group">
      <label>S·ªë ti·ªÅn</label>
      <input id="soTien" type="number">
    </div>
    <div class="form-group">
      <label>T√™n KH</label>
      <input id="tenKH" type="text" readonly>
    </div>

    <button class="btn-green" id="btnPrint">In h√≥a ƒë∆°n</button>

    <div id="invoice" class="invoice">
      <div class="invoice-date" id="ngayIn"></div>
      <div class="invoice-header">H√ìA ƒê∆†N NH·∫¨N CHUY·ªÇN KHO·∫¢N H·ªò TI·ªÄN ƒêI·ªÜN</div>
      <div id="invoiceContent">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
    </div>

    <div id="qr-reader"></div>

    <input id="fileInput" type="file" accept=".xlsx" style="display:none">
    <datalist id="danhSachKH"></datalist>
  </div>

<script>
let duLieu=[],html5QrcodeScanner=null,scannerRunning=false,scanTimeout=null;
const maKHInput=document.getElementById('maKH'),
      tenKHInput=document.getElementById('tenKH'),
      soTienInput=document.getElementById('soTien'),
      nguoiThuInput=document.getElementById('nguoiThu'),
      invoiceContent=document.getElementById('invoiceContent'),
      ngayIn=document.getElementById('ngayIn'),
      qrReaderDiv=document.getElementById('qr-reader');

function removeVietnameseTones(str){
  return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/ƒê/g,'D');
}
function capNhatNgayIn(){
  const now=new Date();
  ngayIn.textContent='Ng√†y in: '+now.toLocaleDateString('vi-VN')+' ‚Äì '+now.toTimeString().split(' ')[0];
}
function formatVND(n){return Number(n).toLocaleString('vi-VN')+' ‚Ç´';}
capNhatNgayIn();

document.getElementById('btnSearch').onclick=()=>{
  const ma=maKHInput.value.trim().toUpperCase();
  if(!ma){alert('Nh·∫≠p m√£ KH');return;}
  hienThiHoaDon(ma,"Kh√°ch h√†ng",Number(soTienInput.value||0),100);
};

function hienThiHoaDon(ma,ten,soTien,sanLuong){
  capNhatNgayIn();
  const nguoi=nguoiThuInput.value||'-',phi=2000,tong=Number(soTien)+phi;
  const now=new Date(),tg=`Ng√†y ${now.toLocaleDateString('vi-VN')}, Gi·ªù ${now.toTimeString().split(' ')[0]}`;
  invoiceContent.innerHTML=`<p><b>M√£ KH:</b> ${ma}</p><p><b>T√™n KH:</b> ${ten}</p>
  <p><b>∆Ø·ªõc s·∫£n l∆∞·ª£ng:</b> ${sanLuong} kWh</p><p><b>Ph√≠:</b> ${formatVND(phi)}</p>
  <p><b>T·ªïng:</b> ${formatVND(tong)}</p><p><b>Ng∆∞·ªùi thu:</b> ${nguoi}</p>
  <p style='color:green;font-weight:700;text-align:center'>ƒê√É NH·∫¨N TI·ªÄN</p>
  <p style='text-align:center'>${tg}</p><div id='maQR' style='text-align:center;margin-top:10px;'></div>`;
  const qrDiv=document.getElementById('maQR');
  qrDiv.innerHTML='';new QRCode(qrDiv,{text:ma,width:120,height:120});
}

document.getElementById('btnPrint').onclick=()=>{
  const ma=maKHInput.value.trim(),ten=tenKHInput.value.trim()||"Kh√°ch h√†ng",
        soTien=Number(soTienInput.value||0);
  if(!ma||!soTien){alert('Nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');return;}
  hienThiHoaDon(ma,ten,soTien,100);
  const invoice=document.getElementById('invoice');
  const originalHTML=invoice.innerHTML;
  invoice.innerHTML=removeVietnameseTones(originalHTML);
  setTimeout(()=>{window.print();invoice.innerHTML=originalHTML;},800);
};

// CAMERA
document.getElementById('btnScan').onclick=startQrScanner;
function startQrScanner(){
  if(scannerRunning)return stopQrScanner();
  qrReaderDiv.style.display='block';
  Html5Qrcode.getCameras().then(cams=>{
    if(!cams.length){alert('‚ö†Ô∏è Tr√¨nh duy·ªát ch∆∞a c√≥ quy·ªÅn camera!');return;}
    html5QrcodeScanner=new Html5Qrcode('qr-reader');
    html5QrcodeScanner.start(
      {deviceId:{exact:cams[0].id}},
      {fps:10,qrbox:{width:350,height:250}},
      text=>{
        maKHInput.value=text.trim();
        stopQrScanner();
        hienThiHoaDon(text.trim(),"Kh√°ch h√†ng",Number(soTienInput.value||0),100);
      }
    );
    scannerRunning=true;
    scanTimeout=setTimeout(()=>{stopQrScanner();},30000);
  }).catch(()=>alert('‚ö†Ô∏è Kh√¥ng th·ªÉ truy c·∫≠p camera!'));
}
function stopQrScanner(){
  if(html5QrcodeScanner&&scannerRunning){
    html5QrcodeScanner.stop().then(()=>{html5QrcodeScanner.clear();});
  }
  html5QrcodeScanner=null;scannerRunning=false;
  clearTimeout(scanTimeout);
  qrReaderDiv.style.display='none';
}
window.onbeforeunload=()=>stopQrScanner();
</script>
</body>
</html>
