<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thu ti·ªÅn ƒëi·ªán - Mobile V4</title>

  <!-- Th∆∞ vi·ªán -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --blue:#2b8cff;
      --green:#28a745;
      --dark:#222;
      --bg:#fbfbfd;
      --card:#fff;
    }
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{background:#f0f2f7;margin:0;padding:16px;display:flex;justify-content:center}
    .wrap{width:100%;max-width:420px;background:var(--card);border-radius:18px;padding:18px;box-shadow:0 6px 18px rgba(20,20,30,0.08)}
    .btn-primary{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;display:inline-block;cursor:pointer;box-shadow:0 4px 10px rgba(43,140,255,0.2)}
    .form-group{display:flex;gap:10px;align-items:center;margin-top:12px}
    label{width:110px;font-weight:600;color:#111}
    input[type=text],input[type=number]{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-size:14px}
    .small-btn{width:44px;height:44px;border-radius:10px;border:none;background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .btn-green{width:100%;background:var(--green);color:#fff;border:none;padding:10px;font-weight:700;border-radius:10px;font-size:16px;cursor:pointer;margin-top:14px}
    .invoice{margin-top:14px;border-radius:12px;border:2px solid #111;padding:12px;min-height:120px;background:#fff;font-size:15px;line-height:1.35}
    .actions{display:flex;gap:12px;margin-top:12px}
    .actions .btn{flex:1;padding:10px;border-radius:12px;border:2px solid var(--blue);background:#fff;color:var(--blue);font-weight:700;cursor:pointer}
    .actions .btn.primary{background:var(--blue);color:#fff}
    .history{margin-top:12px}
    .history-list{max-height:140px;overflow:auto;border:1px solid #eee;background:#fff;padding:8px;border-radius:8px;font-size:13px}
    #qr-reader{width:100%;margin-top:10px;border-radius:10px;overflow:hidden;display:none}
    @media print {
      body * { visibility: hidden; }
      #invoice, #invoice * { visibility: visible; }
      #invoice { position:absolute; left:0; top:0; width:100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="text-align:center"><button class="btn-primary" id="btnLoad">ƒê·∫©y d·ªØ li·ªáu</button></div>

    <div class="form-group">
      <label>Ng∆∞·ªùi thu ti·ªÅn</label>
      <input id="nguoiThu" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu">
    </div>
    <div class="form-group">
      <label>M√£ kh√°ch h√†ng</label>
      <input id="maKH" list="danhSachKH" placeholder="(t√¨m ki·∫øm)">
      <button class="small-btn" id="btnSearch">üîç</button>
      <button class="small-btn" id="btnScan">üì∑</button>
    </div>
    <div class="form-group">
      <label>S·ªë ti·ªÅn</label>
      <input id="soTien" type="number" placeholder="">
    </div>
    <div class="form-group">
      <label>T√™n KH</label>
      <input id="tenKH" type="text" placeholder="" readonly>
    </div>

    <!-- N√∫t In m√†u xanh l√° -->
    <button class="btn-green" id="btnPrint">In h√≥a ƒë∆°n</button>

    <div id="invoice" class="invoice">
      <div id="invoiceContent">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnConfirm">X√°c nh·∫≠n ƒë√£ thu</button>
    </div>

    <div id="qr-reader"></div>

    <div class="history">
      <div style="font-weight:700;margin-bottom:6px">L·ªãch s·ª≠ in</div>
      <div class="history-list" id="historyList"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button style="flex:1;background:#f3f3f3;border:none;border-radius:10px;padding:10px" id="btnExportIn">Xu·∫•t l·ªãch s·ª≠ in</button>
      <button style="flex:1;background:#f3f3f3;border:none;border-radius:10px;padding:10px" id="btnExportThu">Xu·∫•t l·ªãch s·ª≠ thu</button>
    </div>
    <button style="width:100%;background:#f3f3f3;border:none;border-radius:10px;padding:10px;margin-top:8px" id="btnExportExcel">Xu·∫•t Excel</button>
    <button style="width:100%;background:#fff;border:1px solid #eee;border-radius:10px;padding:10px;margin-top:8px" id="btnClear">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>

    <input id="fileInput" type="file" accept=".xlsx" style="display:none">
    <datalist id="danhSachKH"></datalist>
  </div>

<script>
  let duLieu = [];
  let lichSuIn = JSON.parse(localStorage.getItem('lichSuIn') || '[]');
  let lichSuThu = JSON.parse(localStorage.getItem('lichSuThu') || '[]');

  const btnLoad = document.getElementById('btnLoad');
  const fileInput = document.getElementById('fileInput');
  const maKHInput = document.getElementById('maKH');
  const tenKHInput = document.getElementById('tenKH');
  const soTienInput = document.getElementById('soTien');
  const nguoiThuInput = document.getElementById('nguoiThu');
  const btnSearch = document.getElementById('btnSearch');
  const btnScan = document.getElementById('btnScan');
  const invoiceContent = document.getElementById('invoiceContent');
  const historyList = document.getElementById('historyList');
  const btnPrint = document.getElementById('btnPrint');
  const btnConfirm = document.getElementById('btnConfirm');
  const btnExportIn = document.getElementById('btnExportIn');
  const btnExportThu = document.getElementById('btnExportThu');
  const btnExportExcel = document.getElementById('btnExportExcel');
  const btnClear = document.getElementById('btnClear');
  const qrReaderDiv = document.getElementById('qr-reader');

  function capNhatLichSu(){
    historyList.innerHTML = '';
    lichSuIn.forEach(item=>{
      const div=document.createElement('div');
      div.textContent=`(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`;
      historyList.appendChild(div);
    });
  }
  function formatVND(n){return Number(n).toLocaleString('vi-VN')+' ‚Ç´';}
  capNhatLichSu();

  btnLoad.onclick=()=>fileInput.click();
  fileInput.onchange=docFileExcel;
  function docFileExcel(e){
    const f=e.target.files[0];if(!f)return;
    const r=new FileReader();
    r.onload=(ev)=>{
      const wb=XLSX.read(new Uint8Array(ev.target.result),{type:'array'});
      const sh=wb.Sheets[wb.SheetNames[0]];
      duLieu=XLSX.utils.sheet_to_json(sh).map(r=>({
        MA_KHTT:String(r.MA_KHTT||r['M√£ KH']||'').trim().toUpperCase().replace(/(\.0)$/,''),
        TEN_KHTT:String(r.TEN_KHTT||r['T√™n']||'').trim(),
        TONG_NOP:String(r.TONG_NOP||r['S·ªë ti·ªÅn']||'').replace(/[^0-9]/g,'')
      }));
      const dl=document.getElementById('danhSachKH');dl.innerHTML='';
      duLieu.forEach(r=>{const o=document.createElement('option');o.value=r.MA_KHTT;dl.appendChild(o)});
      alert('ƒê·∫©y d·ªØ li·ªáu th√†nh c√¥ng!');
    };
    r.readAsArrayBuffer(f);
  }

  btnSearch.onclick=timKiemMaKH;
  function timKiemMaKH(){
    const ma=maKHInput.value.trim().toUpperCase();
    const kh=duLieu.find(r=>r.MA_KHTT===ma);
    if(!kh){invoiceContent.innerText='[Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng]';return;}
    tenKHInput.value=kh.TEN_KHTT;soTienInput.value=kh.TONG_NOP;
    const sanLuong=tinhSanLuongTuSoTien(Number(kh.TONG_NOP));
    hienThiHoaDon(kh.MA_KHTT,kh.TEN_KHTT,Number(kh.TONG_NOP),sanLuong);
  }
  function tinhSanLuongTuSoTien(soTien){
    const bac=[{s:55,g:1984},{s:52,g:2050},{s:103,g:2380},{s:103,g:2998},{s:103,g:3350},{s:287,g:3460}];
    let tong=0,tien=soTien;for(let i of bac){const tb=i.s*i.g;if(tien>=tb){tong+=i.s;tien-=tb;}else{tong+=Math.floor(tien/i.g);break;}}
    return tong;
  }
  function hienThiHoaDon(ma,ten,soTien,sanLuong){
    const nguoi=nguoiThuInput.value||'-',phi=2000,tong=Number(soTien)+phi;
    const now=new Date(),ngay=now.toLocaleDateString('vi-VN'),gio=now.toTimeString().split(' ')[0];
    const tg=`Ng√†y ${ngay}, Gi·ªù ${gio}`;
    invoiceContent.innerHTML=`
      <div style='text-align:center;font-weight:700;font-size:18px;'>THU TI·ªÄN ƒêI·ªÜN</div>
      <p><b>M√£ KH:</b> ${ma}</p>
      <p><b>T√™n KH:</b> ${ten}</p>
      <p><b>∆Ø·ªõc s·∫£n l∆∞·ª£ng:</b> ${sanLuong} kWh</p>
      <p><b>Ph√≠:</b> ${formatVND(phi)}</p>
      <p><b>T·ªïng:</b> ${formatVND(tong)}</p>
      <p><b>Ng∆∞·ªùi thu:</b> ${nguoi}</p>
      <p style='color:green;font-weight:700;text-align:center'>ƒê√É NH·∫¨N TI·ªÄN</p>
      <p style='text-align:center'>${tg}</p>
      <div id='maQR' style='text-align:center;margin-top:10px;'></div>
    `;
    const qrDiv=document.getElementById('maQR');qrDiv.innerHTML='';
    new QRCode(qrDiv,{text:ma,width:100,height:100});
  }

  btnPrint.onclick=()=>{
    const ma=maKHInput.value.trim(),ten=tenKHInput.value.trim(),soTien=Number(soTienInput.value||0);
    if(!ma||!ten||!soTien){alert('Nh·∫≠p ƒë·ªß th√¥ng tin tr∆∞·ªõc khi in!');return;}
    const san=tinhSanLuongTuSoTien(soTien);
    hienThiHoaDon(ma,ten,soTien,san);
    const tong=soTien+2000,thoiGian=new Date().toLocaleString();
    lichSuIn.push({maKH:ma,tenKH:ten,soTien:tong,thoiGian});
    lichSuThu.push({maKH:ma,tenKH:ten,soTien:tong,thoiGian});
    localStorage.setItem('lichSuIn',JSON.stringify(lichSuIn));
    localStorage.setItem('lichSuThu',JSON.stringify(lichSuThu));
    capNhatLichSu();
    stopQrScannerIfRunning();
    setTimeout(()=>window.print(),500);
  };

  btnConfirm.onclick=()=>{
    const ma=maKHInput.value.trim(),ten=tenKHInput.value.trim(),soTien=Number(soTienInput.value||0);
    if(!ma||!ten||!soTien){alert('Thi·∫øu th√¥ng tin');return;}
    const tong=soTien+2000,thoiGian=new Date().toLocaleString();
    lichSuThu.push({maKH:ma,tenKH:ten,soTien:tong,thoiGian});
    localStorage.setItem('lichSuThu',JSON.stringify(lichSuThu));
    capNhatLichSu();alert('ƒê√£ l∆∞u');
  };

  function exportCsv(arr,fn){
    const head='M√£ KH,T√™n KH,S·ªë ti·ªÅn,Th·ªùi gian\n';
    const rows=arr.map(i=>`${i.maKH},${i.tenKH},${i.soTien},${i.thoiGian}`).join('\n');
    const blob=new Blob([head+rows],{type:'text/csv'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fn;a.click();
  }
  btnExportIn.onclick=()=>exportCsv(lichSuIn,'lich_su_in.csv');
  btnExportThu.onclick=()=>exportCsv(lichSuThu,'lich_su_thu.csv');
  btnExportExcel.onclick=()=>exportCsv([...lichSuIn,...lichSuThu],'lich_su_all.csv');
  btnClear.onclick=()=>{if(confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠?')){lichSuIn=[];lichSuThu=[];localStorage.removeItem('lichSuIn');localStorage.removeItem('lichSuThu');capNhatLichSu();}};

  let html5QrcodeScanner=null,scannerRunning=false;
  btnScan.onclick=startQrScanner;
  function startQrScanner(){
    if(scannerRunning)return stopQrScannerIfRunning();
    qrReaderDiv.style.display='block';
    html5QrcodeScanner=new Html5Qrcode('qr-reader');
    Html5Qrcode.getCameras().then(c=>{
      const camId=c[0].id;
      html5QrcodeScanner.start({deviceId:{exact:camId}},{fps:10,qrbox:{width:250,height:250}},
        (text)=>{maKHInput.value=text.trim();timKiemMaKH();stopQrScannerIfRunning();},
        (err)=>{});
      scannerRunning=true;
    });
  }
  function stopQrScannerIfRunning(){
    if(html5QrcodeScanner&&scannerRunning){
      html5QrcodeScanner.stop().then(()=>{html5QrcodeScanner.clear();html5QrcodeScanner=null;scannerRunning=false;qrReaderDiv.style.display='none';});
    }
  }
  window.onbeforeunload=()=>stopQrScannerIfRunning();
</script>
</body>
</html>
