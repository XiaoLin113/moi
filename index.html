<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thu ti·ªÅn ƒëi·ªán</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    /* CSS CHUNG CHO GIAO DI·ªÜN DI ƒê·ªòNG */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 15px;
      background: #f0f2f5;
    }
    .container {
      max-width: 600px;
      margin: auto;
    }
    .card {
      background-color: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }
    h3 {
      text-align: center;
      color: #333;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }
    .input-group label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #555;
    }
    .input-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .input-group input[readonly] {
      background-color: #f8f9fa;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .button-group button {
      flex: 1; 
      padding: 12px 8px; 
      border: none;
      border-radius: 8px;
      font-size: 14px; 
      font-weight: bold;
      cursor: pointer;
      color: #fff;
    }
    /* C√°c n√∫t ch·ª©c nƒÉng */
    .excel-button, .primary-button {
      background-color: #007bff;
    }
    .secondary-button {
      background-color: #6c757d;
    }
    #inButton {
      background-color: #28a745;
    }
    #fileInput {
      display: none;
    }

    /* CSS HI·ªÇN TH·ªä H√ìA ƒê∆†N TR√äN M√ÄN H√åNH */
    #hoaDon {
      width: 100%;
      min-height: 250px;
      border: 2px solid #333; /* Khung cho h√≥a ƒë∆°n hi·ªÉn th·ªã */
      padding: 15px;
      border-radius: 8px;
      background-color: #fafafa;
      white-space: pre-wrap;
      font-family: Arial, sans-serif; /* D√πng Arial ƒë·ªÉ ƒë·ªìng b·ªô v·ªõi in nhi·ªát */
      font-size: 14px; /* Gi·∫£m c·ª° ch·ªØ ƒë·ªÉ m√¥ ph·ªèng in nhi·ªát */
      line-height: 1.5;
    }
    #hoaDon p { margin: 0; }
    #reader {
      width: 100%;
      border: 1px dashed #ccc;
      border-radius: 8px;
    }

    /* CSS ƒê·∫∂C BI·ªÜT CHO M√ÅY IN NHI·ªÜT K57 */
    @media print {
      body {
        margin: 0;
        padding: 0;
        /* Bu·ªôc ch·ªâ in m·ªôt trang */
        overflow: hidden; 
      }
      /* ·∫®n t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ ngo·∫°i tr·ª´ h√≥a ƒë∆°n */
      body > :not(#print-area) {
        display: none !important;
      }

      /* Khu v·ª±c in ch√≠nh */
      #print-area {
        display: block;
        width: 57mm; /* Chi·ªÅu r·ªông chu·∫©n cho K57 */
        /* Gi·∫£m margin ƒë·ªÉ t·ªëi ƒëa h√≥a di·ªán t√≠ch in */
        padding: 0;
        margin: 0;
        box-shadow: none;
        border: none;
        background-color: white;
      }
      
      /* C·∫•u h√¨nh n·ªôi dung h√≥a ƒë∆°n cho K57 */
      #hoaDon {
        /* B·ªè border khi in */
        border: none !important;
        padding: 5px; 
        font-size: 8pt; /* R·∫•t quan tr·ªçng: c·ª° ch·ªØ nh·ªè cho m√°y in nhi·ªát */
        font-family: Arial, sans-serif;
        line-height: 1.2;
        color: black;
        /* ƒê·∫£m b·∫£o khung n·ªôi dung kh√¥ng b·ªã tr√†n */
        width: 100%; 
        box-sizing: border-box;
      }
      
      /* C√°c th√†nh ph·∫ßn con trong h√≥a ƒë∆°n */
      #hoaDon * {
        font-size: inherit;
        line-height: inherit;
        margin: 0 !important;
        padding: 0 !important;
      }

      /* ƒê·∫£m b·∫£o QR code hi·ªÉn th·ªã r√µ */
      #maQR img {
        width: 40mm !important; 
        height: 40mm !important;
      }
    }
  </style>
</head>
<body>

<div class="container">
  
  <div class="card">
    <button onclick="document.getElementById('fileInput').click()" class="excel-button">
      ƒê·∫©y d·ªØ li·ªáu Excel
    </button>
    <input type="file" id="fileInput" accept=".xlsx" onchange="docFileExcel(event)" />
  </div>

  <div class="card">
    <h3>T√¨m ki·∫øm v√† thao t√°c</h3>
    <div class="input-group">
      <label for="maKH">M√£ kh√°ch h√†ng</label>
      <input id="maKH" list="danhSachKH" onkeydown="if(event.key==='Enter'){timKiemMaKH()}" placeholder="Nh·∫≠p ho·∫∑c qu√©t QR code"/>
      <datalist id="danhSachKH"></datalist>
    </div>
    
    <div class="button-group">
      <button onclick="timKiemMaKH()" class="primary-button">üîç T√¨m</button>
      <button id="startScanButton" onclick="startScanner()" class="secondary-button">üì∑ Qu√©t QR</button>
      <button id="inButton" onclick="inHoaDon()">üñ®Ô∏è In H√≥a ƒê∆°n</button>
    </div>

    <div id="reader" style="display:none; margin-top: 15px;"></div>
  </div>

  <div class="card">
    <h3>Chi ti·∫øt h√≥a ƒë∆°n</h3>
    <div class="input-group">
      <label for="tenKH">T√™n KH</label>
      <input id="tenKH" readonly/>
    </div>
    <div class="input-group">
      <label for="soTien">S·ªë ti·ªÅn</label>
      <input id="soTien" readonly/>
    </div>
    <div class="input-group">
      <div id="print-area">
          <div id="hoaDon">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
      </div>
    </div>
  </div>
  
  <div class="card">
    <h3>L·ªãch s·ª≠ thu ti·ªÅn</h3>
    <textarea id="lichSuThu" readonly rows="5"></textarea>
    <div class="button-group">
      <button onclick="xuatLichSu('thu')" class="secondary-button">Xu·∫•t l·ªãch s·ª≠</button>
      <button onclick="xuatLichSuExcel()" class="secondary-button">Xu·∫•t Excel</button>
      <button onclick="xoaLichSu()" class="secondary-button">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
    </div>
  </div>
</div>

<script>
// D·ªØ li·ªáu v√† h√†m logic ƒë∆∞·ª£c gi·ªØ nguy√™n t·ª´ m√£ c≈©, ƒë√£ ƒë∆∞·ª£c tinh ch·ªânh l·∫°i cho ph√π h·ª£p
const bangGiaDien = [
  { sanLuong: 55, donGia: 1984 },
  { sanLuong: 52, donGia: 2050 },
  { sanLuong: 103, donGia: 2380 },
  { sanLuong: 103, donGia: 2998 },
  { sanLuong: 103, donGia: 3350 },
  { sanLuong: 287, donGia: 3460 }
];

let duLieu = [];
let lichSuIn = JSON.parse(localStorage.getItem("lichSuIn")) || [];
let lichSuThu = JSON.parse(localStorage.getItem("lichSuThu")) || [];
let html5QrCode;

function formatVND(number) { return Number(number).toLocaleString('vi-VN') + ' ‚Ç´'; }
function removeAccents(str) { return str.normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }

function tinhSanLuongTuSoTien(soTien) {
  let tongSanLuong = 0;
  let tienConLai = soTien;
  for (let i = 0; i < bangGiaDien.length; i++) {
    const bac = bangGiaDien[i];
    const tienBac = bac.sanLuong * bac.donGia;
    if (tienConLai >= tienBac) {
      tongSanLuong += bac.sanLuong;
      tienConLai -= tienBac;
    } else {
      const sanLuongConLai = Math.floor(tienConLai / bac.donGia);
      tongSanLuong += sanLuongConLai;
      break;
    }
  }
  return tongSanLuong;
}

function timKiemMaKH() {
  const maKH = document.getElementById("maKH").value.trim();
  const ketQua = duLieu.filter(row => String(row.MA_KHTT).trim() === maKH);
  
  if (ketQua.length > 0) {
    const kh = ketQua[0];
    document.getElementById("tenKH").value = kh.TEN_KHTT;
    document.getElementById("soTien").value = kh.TONG_NOP;
    const sanLuong = tinhSanLuongTuSoTien(Number(kh.TONG_NOP));
    hienThiHoaDon(kh.MA_KHTT, kh.TEN_KHTT, kh.TONG_NOP, sanLuong);
  } else {
    document.getElementById("hoaDon").innerText = "[Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng]";
    document.getElementById("tenKH").value = "";
    document.getElementById("soTien").value = "";
  }
}

function hienThiHoaDon(maKH, tenKH, soTien, sanLuong) {
  // ƒê√£ x√≥a input "ng∆∞·ªùi thu" v√† "ti√™u ƒë·ªÅ" n√™n fix c·ª©ng
  const nguoiThu = "-"; 
  const tieuDe = "HOA DON NHAN CHUYEN KHOAN HO TIEN DIEN"; 
  const phi = 2000;
  const tong = Number(soTien) + phi;
  const now = new Date();
  const ngay = now.toLocaleDateString('vi-VN');
  const gio = now.toTimeString().split(' ')[0].slice(0, 5);
  const thoiGian = `Ngay ${ngay}, Gio ${gio}`;
  
  // L∆∞u √Ω: D√πng removeAccents() ƒë·ªÉ lo·∫°i b·ªè d·∫•u cho in nhi·ªát (gi√∫p m√°y in kh√¥ng b·ªã l·ªói font)
  const noiDung = `
    <div style="text-align:center; font-weight:bold; margin-bottom:5px;">${removeAccents(tieuDe).toUpperCase()}</div>
    <div style="text-align:center; font-weight:bold; margin-bottom:10px;">THU TIEN DIEN</div>
    
    <p>Ma KH: ${removeAccents(maKH)}</p>
    <p>Ten KH: ${removeAccents(tenKH)}</p>
    <p>Uoc san luong: ${sanLuong} kWh</p>
    <p>Phi: ${formatVND(phi)}</p>
    <p style="font-weight:bold;">TONG: ${formatVND(tong)}</p>
    <p>Nguoi thu: ${removeAccents(nguoiThu)}</p>
    
    <div style="text-align:center; font-weight:bold; margin-top:10px;">DA NHAN TIEN</div>
    <p style="text-align:center;">${thoiGian}</p>
    
    <div id="maQR" style="text-align:center; margin-top:5px;"></div>
  `;
  document.getElementById("hoaDon").innerHTML = noiDung.trim();
  
  const barcodeContainer = document.getElementById("maQR");
  barcodeContainer.innerHTML = '';
  // Gi·∫£m k√≠ch th∆∞·ªõc QR code ƒë·ªÉ v·ª´a kh·ªï K57
  new QRCode(barcodeContainer, {
    text: maKH,
    width: 80, 
    height: 80 
  });
}

function inHoaDon() {
  const maKH = document.getElementById("maKH").value.trim();
  const tenKH = document.getElementById("tenKH").value.trim();
  const soTien = Number(document.getElementById("soTien").value || 0);
  if (!maKH || !tenKH || !soTien) {
    alert("‚ö†Ô∏è B·∫°n c·∫ßn t√¨m ƒë√∫ng m√£ KH tr∆∞·ªõc khi in!");
    return;
  }
  const tong = soTien + 2000;
  const thoiGian = new Date().toLocaleString();
  
  // L∆∞u l·ªãch s·ª≠
  lichSuIn.push({ maKH, tenKH, soTien: tong, thoiGian });
  lichSuThu.push({ maKH, tenKH, soTien: tong, thoiGian });
  localStorage.setItem("lichSuIn", JSON.stringify(lichSuIn));
  localStorage.setItem("lichSuThu", JSON.stringify(lichSuThu));
  capNhatLichSu();

  // G·ªçi h√†m in
  setTimeout(() => { window.print(); }, 500);
}

// C√°c h√†m kh√°c (L·ªãch s·ª≠, Excel, Qu√©t QR) ƒë∆∞·ª£c gi·ªØ nguy√™n v√† ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông
function capNhatLichSu() {
  const thuText = lichSuThu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  document.getElementById("lichSuThu").value = thuText;
}

function xuatLichSu(loai) {
  const duLieu = loai === 'in' ? lichSuIn : lichSuThu;
  const text = duLieu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${item.soTien}`).join("\n");
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `lich_su_${loai}.txt`;
  a.click();
}

function xuatLichSuExcel() {
  const wb = XLSX.utils.book_new();
  const wsThu = XLSX.utils.json_to_sheet(lichSuThu);
  XLSX.utils.book_append_sheet(wb, wsThu, "Lich Su Thu");
  XLSX.writeFile(wb, "lich_su_thu.xlsx");
}

function docFileExcel(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    duLieu = XLSX.utils.sheet_to_json(sheet);
    duLieu = duLieu.map(row => {
      return {
        MA_KHTT: String(row.MA_KHTT || "").trim().toUpperCase().replace(/(\.0)$/, ""),
        TEN_KHTT: String(row.TEN_KHTT || "").trim(),
        TONG_NOP: String(row.TONG_NOP || "").replace(/[^0-9]/g, "")
      };
    });
    const dataList = document.getElementById("danhSachKH");
    dataList.innerHTML = "";
    duLieu.forEach(row => {
      const option = document.createElement("option");
      option.value = row.MA_KHTT;
      dataList.appendChild(option);
    });
    alert("ƒê·∫©y d·ªØ li·ªáu th√†nh c√¥ng!");
  };
  reader.readAsArrayBuffer(file);
}

function xoaLichSu() {
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ kh√¥ng?")) {
    localStorage.removeItem("lichSuIn");
    localStorage.removeItem("lichSuThu");
    lichSuIn = [];
    lichSuThu = [];
    capNhatLichSu();
  }
}

function startScanner() {
  const qrCodeRegionId = "reader";
  const scannerContainer = document.getElementById(qrCodeRegionId);
  const startScanButton = document.getElementById("startScanButton");

  if (html5QrCode && html5QrCode.isScanning) {
    html5QrCode.stop().then(() => {
      scannerContainer.style.display = 'none';
      startScanButton.textContent = 'üì∑ Qu√©t QR';
    }).catch(err => {
      console.error("L·ªói khi d·ª´ng m√°y qu√©t: ", err);
    });
    return;
  }

  scannerContainer.style.display = 'block';
  startScanButton.textContent = 'D·ª´ng qu√©t';

  html5QrCode = new Html5Qrcode(qrCodeRegionId);
  Html5Qrcode.getCameras().then(cameras => {
    if (cameras.length > 0) {
      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 250, height: 250 }
        },
        (decodedText, decodedResult) => {
          document.getElementById("maKH").value = decodedText;
          timKiemMaKH();
          html5QrCode.stop().then(() => {
            scannerContainer.style.display = 'none';
            startScanButton.textContent = 'üì∑ Qu√©t QR';
          });
        },
        (errorMessage) => {}
      ).catch(err => {
        alert("Kh√¥ng th·ªÉ b·∫≠t camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.");
        scannerContainer.style.display = 'none';
        startScanButton.textContent = 'üì∑ Qu√©t QR';
      });
    } else {
      alert("Kh√¥ng t√¨m th·∫•y camera tr√™n thi·∫øt b·ªã c·ªßa b·∫°n.");
      scannerContainer.style.display = 'none';
      startScanButton.textContent = 'üì∑ Qu√©t QR';
    }
  }).catch(err => {
    alert("L·ªói khi truy c·∫≠p camera.");
    scannerContainer.style.display = 'none';
    startScanButton.textContent = 'üì∑ Qu√©t QR';
  });
}

window.onload = capNhatLichSu;
</script>
</body>
</html>
