<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thu ti·ªÅn ƒëi·ªán</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f0f0f0;
      max-width: 100vw;
      min-height: 100vh;
      font-size: 17px;
    }
    .container {
      max-width: 430px;
      margin: auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 4px 16px #bbb8;
      padding: 18px 6px 24px;
      min-height: 100vh;
    }
    input, button, textarea {
      font-size: 17px;
      margin: 7px 0;
      padding: 10px 8px;
      border-radius: 10px;
      border: 1px solid #ddd;
    }
    input:focus, textarea:focus {
      border: 1.5px solid #4387fd;
      outline: none;
    }
    button {
      background: #4387fd;
      color: #fff;
      border: none;
      font-weight: bold;
      margin-left: 5px;
      min-width: 46px;
      min-height: 40px;
      cursor: pointer;
      box-shadow: 0 2px 8px #bbb4;
    }
    button:active { background: #3066b2; }
    h2 { text-align: center; margin-bottom: 16px; }
    .row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .label { width: 120px; min-width: 90px; flex-shrink: 0; }
    #maKH, #tenKH, #soTien, #nguoiThuTien {
      flex: 1; min-width: 0; background: #f8f8f8;
    }
    #hoaDon {
      width: 100%;
      min-height: 180px;
      border: 2px solid #000;
      border-radius: 13px;
      padding: 14px 7px;
      white-space: pre-wrap;
      font-size: 17px;
      font-family: "Times New Roman", serif;
      margin-bottom: 12px;
      background: #faf9f7;
      box-shadow: 0 2px 8px #eee;
      text-align: left;
    }
    .action-btns {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 18px;
    }
    .history-area {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }
    #lichSuIn, #lichSuThu {
      width: 100%;
      min-height: 72px;
      resize: vertical;
    }
    .history-btns {
      display: flex;
      gap: 7px;
      justify-content: flex-end;
    }
    #qr-reader {
      width: 98vw !important;
      max-width: 360px;
      margin: 12px auto;
      display: none;
      border-radius: 18px;
      box-shadow: 0 4px 24px #ccc;
      background: #fafafa;
      overflow: hidden;
    }

    /* CSS in ch·ªâ ph·∫ßn h√≥a ƒë∆°n - kh·ªï 58mm */
    @media print {
      body * {
        visibility: hidden !important;
      }
      #hoaDon, #hoaDon * {
        visibility: visible !important;
      }
      #hoaDon {
        position: absolute;
        left: 0;
        top: 0;
        width: 58mm; /* kh·ªï gi·∫•y */
        font-size: 14px;
        border: none;
        margin: 0;
        padding: 0;
        box-shadow: none;
        background: #fff;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Thu ti·ªÅn ƒëi·ªán</h2>
  <div class="row" style="justify-content:center;">
    <button onclick="document.getElementById('fileInput').click()">ƒê·∫©y d·ªØ li·ªáu</button>
    <input type="file" id="fileInput" style="display:none" accept=".xls,.xlsx" onchange="docFileExcel(event)">
  </div>
  <div class="row">
    <label class="label">Ng∆∞·ªùi thu ti·ªÅn</label>
    <input id="nguoiThuTien" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu">
  </div>
  <div class="row">
    <label class="label">M√£ kh√°ch h√†ng</label>
    <input id="maKH" list="danhSachKH" placeholder="(t√¨m ki·∫øm)" onkeydown="if(event.key==='Enter'){timKiemMaKH()}">
    <datalist id="danhSachKH"></datalist>
    <button onclick="timKiemMaKH()">üîç</button>
    <button onclick="batDauQuetQR()">üì∑</button>
  </div>
  <div id="qr-reader"></div>
  <div class="row">
    <label class="label">S·ªë ti·ªÅn</label>
    <input id="soTien" readonly>
  </div>
  <div class="row">
    <label class="label">T√™n KH</label>
    <input id="tenKH" readonly>
  </div>

  <div id="hoaDon">
    <div id="hoaDonText">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
    <div id="qrCodeArea" style="margin-top:12px;text-align:center;"></div>
  </div>

  <div class="action-btns">
    <button onclick="inHoaDon()">In</button>
    <button style="border:2px solid #000" onclick="xacNhanThu()">X√°c nh·∫≠n ƒë√£ thu</button>
  </div>

  <div class="history-area">
    <label>L·ªãch s·ª≠ in</label>
    <textarea id="lichSuIn" readonly></textarea>
    <label><b>L·ªãch s·ª≠ thu</b></label>
    <textarea id="lichSuThu" readonly></textarea>
    <div class="history-btns">
      <button onclick="xuatLichSu('in')">Xu·∫•t l·ªãch s·ª≠ in</button>
      <button onclick="xuatLichSu('thu')">Xu·∫•t l·ªãch s·ª≠ thu</button>
      <button onclick="xuatLichSuExcel()">Xu·∫•t Excel</button>
      <button onclick="xoaLichSu()">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
    </div>
  </div>
</div>

<script>
let duLieu=[],lichSuIn=JSON.parse(localStorage.getItem('lichSuIn')||'[]'),lichSuThu=JSON.parse(localStorage.getItem('lichSuThu')||'[]');
const phiCoDinh=2000;
function formatVND(n){return Number(n).toLocaleString('vi-VN')+' ‚Ç´';}

function docFileExcel(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    duLieu = XLSX.utils.sheet_to_json(sheet).map(row => ({
      MA_KHTT: String(row.MA_KHTT || row.MA || "").trim().toUpperCase().replace(/(\.0)$/,""),
      TEN_KHTT: String(row.TEN_KHTT || row.TEN || "").trim(),
      TONG_NOP: String(row.TONG_NOP || row.TIEN || "").replace(/[^0-9]/g, "")
    }));
    const dataList = document.getElementById("danhSachKH");
    dataList.innerHTML = "";
    duLieu.forEach(row => {
      const option = document.createElement("option");
      option.value = row.MA_KHTT;
      dataList.appendChild(option);
    });
    alert("ƒê·∫©y d·ªØ li·ªáu th√†nh c√¥ng!");
  };
  reader.readAsArrayBuffer(file);
}

function timKiemMaKH(){
  const ma=document.getElementById('maKH').value.trim();
  const kh=duLieu.find(r=>r.MA_KHTT===ma);
  if(!kh){document.getElementById('hoaDonText').textContent='[Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng]';return;}
  document.getElementById('tenKH').value=kh.TEN_KHTT;
  document.getElementById('soTien').value=kh.TONG_NOP;
  hienThiHoaDon(ma, kh.TEN_KHTT, kh.TONG_NOP);
}

function hienThiHoaDon(ma, ten, so){
  const nguoi = document.getElementById('nguoiThuTien').value || '-';
  const tong = Number(so) + phiCoDinh;
  const now = new Date();
  const t = `Ngay ${now.toLocaleDateString('vi-VN')}, Gio ${now.toTimeString().slice(0,8)}`;
  const txt = `BIEN LAI NHAN TIEN CHUYEN KHOAN

Ma KH: ${ma}
Ten KH: ${ten}
Tong tien: ${formatVND(tong)}
Nguoi thu tien: ${nguoi}

DA NHAN TIEN
${t}`;

  document.getElementById('hoaDonText').textContent = txt;
  const qrArea = document.getElementById('qrCodeArea');
  qrArea.innerHTML = '';
  new QRCode(qrArea, { text: ma, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.H });
}

function capNhatLichSu(){
  document.getElementById('lichSuIn').value=lichSuIn.map(i=>`(${i.thoiGian}) ${i.maKH}-${i.tenKH}: ${formatVND(i.soTien)}`).join('\n');
  document.getElementById('lichSuThu').value=lichSuThu.map(i=>`(${i.thoiGian}) ${i.maKH}-${i.tenKH}: ${formatVND(i.soTien)}`).join('\n');
}

function removeDiacritics(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
}

function inHoaDon(){
  const hoaDon = document.getElementById('hoaDon').cloneNode(true);
  hoaDon.innerHTML = removeDiacritics(hoaDon.innerHTML);

  const printWindow = window.open('', '', 'width=600,height=400');
  printWindow.document.write('<html><head><title>In H√≥a ƒë∆°n</title>');
  printWindow.document.write('<style>@media print { body{margin:0;font-size:14px;font-family:Arial;} }</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write(hoaDon.outerHTML);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
  printWindow.close();
}

function xacNhanThu(){
  const ma=document.getElementById('maKH').value,ten=document.getElementById('tenKH').value,so=Number(document.getElementById('soTien').value||0)+phiCoDinh;
  lichSuThu.push({maKH:ma,tenKH:ten,soTien:so,thoiGian:new Date().toLocaleString()});
  localStorage.setItem('lichSuThu',JSON.stringify(lichSuThu));capNhatLichSu();
}

function xuatLichSu(loai){
  const arr=loai==='in'?lichSuIn:lichSuThu;
  const txt=arr.map(i=>`(${i.thoiGian}) ${i.maKH}-${i.tenKH}: ${i.soTien}`).join('\n');
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([txt],{type:'text/plain'}));a.download=`lich_su_${loai}.txt`;a.click();
}

function xuatLichSuExcel(){
  const ws=XLSX.utils.json_to_sheet([...lichSuIn.map(x=>({...x,Loai:'In'})),...lichSuThu.map(x=>({...x,Loai:'Thu'}))]);
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'LichSu');XLSX.writeFile(wb,'lich_su.xlsx');
}

function xoaLichSu(){
  if(confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠?')){lichSuIn=[];lichSuThu=[];localStorage.removeItem('lichSuIn');localStorage.removeItem('lichSuThu');capNhatLichSu();}
}

let html5QrCode;
function batDauQuetQR(){
  const region=document.getElementById('qr-reader');region.style.display='block';
  if(!html5QrCode)html5QrCode=new Html5Qrcode('qr-reader');
  html5QrCode.start({facingMode:'environment'},{fps:10,qrbox:250},
    msg=>{document.getElementById('maKH').value=msg;region.style.display='none';html5QrCode.stop();timKiemMaKH();},
    err=>{}
  ).catch(()=>{alert('Kh√¥ng m·ªü ƒë∆∞·ª£c camera');region.style.display='none';});
}
window.onload=capNhatLichSu;
</script>
</body>
</html>
