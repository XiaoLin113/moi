<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H√≥a ƒë∆°n ƒëi·ªán thu h·ªô</title>

  <!-- Th∆∞ vi·ªán -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --blue:#2b8cff;
      --green:#28a745;
      --card:#fff;
      --input-radius:10px;
    }
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{background:#f0f2f7;margin:0;padding:16px;display:flex;justify-content:center}
    .wrap{width:100%;max-width:480px;background:var(--card);border-radius:18px;padding:18px;box-shadow:0 6px 18px rgba(20,20,30,0.06)}
    .btn-primary{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;display:inline-block;cursor:pointer;box-shadow:0 4px 10px rgba(43,140,255,0.18)}
    .form-row{display:flex;gap:12px;align-items:center;margin-top:12px}
    label{width:120px;font-weight:700;color:#111;font-size:15px}
    input[type=text],input[type=number]{flex:1;padding:12px 14px;border-radius:var(--input-radius);border:1px solid #ccc;font-size:15px;height:48px}
    .half-buttons{display:flex;gap:12px;margin-top:10px}
    .half-buttons button{flex:1;background:var(--blue);color:#fff;border:none;border-radius:var(--input-radius);padding:12px;font-size:16px;font-weight:700;cursor:pointer;height:52px}
    .btn-green{width:100%;background:var(--green);color:#fff;border:none;padding:14px;font-weight:700;border-radius:var(--input-radius);font-size:17px;cursor:pointer;margin-top:14px}
    .invoice{margin-top:14px;border-radius:10px;border:1px solid #ccc;padding:16px;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,0.05);font-size:15px;line-height:1.4;position:relative}
    .invoice-header{text-align:center;font-weight:800;font-size:18px;text-transform:uppercase;margin-bottom:8px}
    .invoice-date{position:absolute;top:8px;right:12px;font-size:13px;color:#555}
    #qr-reader{width:100%;margin-top:10px;border-radius:10px;overflow:hidden;display:none;background:#000}

    /* --- PH·∫¶N IN CHO M√ÅY IN NHI·ªÜT KH·ªî 57 --- */
    @media print {
      body * { visibility: hidden; }
      #invoice, #invoice * { visibility: visible; }
      #invoice {
        position:absolute; left:0; top:0; width:100%;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.3;
        text-align: left;
        letter-spacing: 0;
      }
      .invoice-header {
        text-align: center;
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 6px;
      }
      p { margin: 2px 0; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div style="text-align:center"><button class="btn-primary" id="btnLoad">ƒê·∫©y d·ªØ li·ªáu</button></div>

    <div class="form-row">
      <label for="nguoiThu">Ng∆∞·ªùi thu ti·ªÅn</label>
      <input id="nguoiThu" type="text" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu">
    </div>

    <div class="form-row">
      <label for="maKH">M√£ kh√°ch h√†ng</label>
      <input id="maKH" list="danhSachKH" placeholder="(t√¨m ki·∫øm)">
    </div>

    <div class="half-buttons">
      <button id="btnSearch">üîç T√¨m</button>
      <button id="btnScan">üì∑ Qu√©t</button>
    </div>

    <div class="form-row">
      <label for="soTien">S·ªë ti·ªÅn</label>
      <input id="soTien" type="number" placeholder="">
    </div>

    <div class="form-row">
      <label for="tenKH">T√™n KH</label>
      <input id="tenKH" type="text" placeholder="" readonly>
    </div>

    <button class="btn-green" id="btnPrint">In h√≥a ƒë∆°n</button>

    <div id="invoice" class="invoice">
      <div class="invoice-date" id="ngayIn"></div>
      <div class="invoice-header">H√ìA ƒê∆†N ƒêI·ªÜN THU H·ªò</div>
      <div id="invoiceContent">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
    </div>

    <div id="qr-reader"></div>
    <datalist id="danhSachKH"></datalist>
  </div>

<script>
let duLieu = [];
let lichSuIn = JSON.parse(localStorage.getItem('lichSuIn') || '[]');
let lichSuThu = JSON.parse(localStorage.getItem('lichSuThu') || '[]');

const maKHInput = document.getElementById('maKH');
const tenKHInput = document.getElementById('tenKH');
const soTienInput = document.getElementById('soTien');
const nguoiThuInput = document.getElementById('nguoiThu');
const invoiceContent = document.getElementById('invoiceContent');
const btnLoad = document.getElementById('btnLoad');
const fileInput = document.getElementById('fileInput');
const btnSearch = document.getElementById('btnSearch');
const btnScan = document.getElementById('btnScan');
const btnPrint = document.getElementById('btnPrint');
const ngayIn = document.getElementById('ngayIn');
const qrReaderDiv = document.getElementById('qr-reader');

function formatVND(n){ return Number(n).toLocaleString('vi-VN') + ' ‚Ç´'; }
function capNhatNgayIn(){
  const now = new Date();
  ngayIn.textContent = 'Ng√†y in: ' + now.toLocaleDateString('vi-VN') + ' - ' + now.toTimeString().split(' ')[0];
}

// T√≠nh s·∫£n l∆∞·ª£ng
function tinhSanLuongTuSoTien(soTien){
  const bac=[{s:55,g:1984},{s:52,g:2050},{s:103,g:2380},{s:103,g:2998},{s:103,g:3350},{s:287,g:3460}];
  let tong=0,tien=soTien;
  for(let i of bac){
    const tb = i.s * i.g;
    if(tien>=tb){ tong+=i.s; tien-=tb; } else { tong += Math.floor(tien/i.g); break; }
  }
  return tong;
}

// ‚úÖ H√≥a ƒë∆°n cƒÉn l·ªÅ chu·∫©n kh·ªï 57
function hienThiHoaDon(ma, ten, soTien, sanLuong){
  capNhatNgayIn();
  const nguoi = nguoiThuInput.value || '-';
  const phi = 2000;
  const tong = Number(soTien) + phi;
  const now = new Date();
  const tg = `Ng√†y ${now.toLocaleDateString('vi-VN')}, Gi·ªù ${now.toTimeString().split(' ')[0]}`;
  
  invoiceContent.innerHTML = `
    <div style="text-align:center;font-weight:700;">------------------------------</div>
    <div style="text-align:center;font-weight:700;">HOA DON DIEN THU HO</div>
    <div style="text-align:center;font-weight:700;">------------------------------</div>
    <p><b>Ma KH:</b> ${ma}</p>
    <p><b>Ten KH:</b> ${ten}</p>
    <p><b>Uoc san luong:</b> ${sanLuong} kWh</p>
    <p><b>Phi:</b> ${formatVND(phi)}</p>
    <p><b>Tong:</b> ${formatVND(tong)}</p>
    <p><b>Nguoi thu:</b> ${nguoi}</p>
    <div style="text-align:center;color:green;font-weight:700;">DA NHAN TIEN</div>
    <p style="text-align:center;">${tg}</p>
    <div id="maQR" style="text-align:center;margin-top:10px;"></div>
  `;
  const qrDiv = document.getElementById('maQR');
  qrDiv.innerHTML = '';
  new QRCode(qrDiv, { text: ma, width: 100, height: 100 });
}

// N√∫t t√¨m
btnSearch.onclick = ()=>{
  const ma = maKHInput.value.trim().toUpperCase();
  if(!ma){ alert('Nh·∫≠p m√£ kh√°ch h√†ng'); return; }
  const kh = duLieu.find(r=>r.MA_KHTT === ma);
  if(!kh){ alert('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng'); return; }
  tenKHInput.value = kh.TEN_KHTT;
  soTienInput.value = kh.TONG_NOP;
  const san = tinhSanLuongTuSoTien(Number(kh.TONG_NOP));
  hienThiHoaDon(kh.MA_KHTT, kh.TEN_KHTT, Number(kh.TONG_NOP), san);
};

// ‚úÖ In h√≥a ƒë∆°n kh√¥ng d·∫•u, cƒÉn l·ªÅ ƒë·∫πp
btnPrint.onclick = ()=>{
  const ma = maKHInput.value.trim();
  const ten = tenKHInput.value.trim();
  const soTien = Number(soTienInput.value || 0);
  if(!ma || !ten || !soTien){ alert('Nh·∫≠p ƒë·ªß th√¥ng tin tr∆∞·ªõc khi in!'); return; }

  const san = tinhSanLuongTuSoTien(soTien);
  hienThiHoaDon(ma, ten, soTien, san);

  const tong = soTien + 2000;
  const thoiGian = new Date().toLocaleString();
  lichSuIn.push({ maKH: ma, tenKH: ten, soTien: tong, thoiGian });
  lichSuThu.push({ maKH: ma, tenKH: ten, soTien: tong, thoiGian });
  localStorage.setItem('lichSuIn', JSON.stringify(lichSuIn));
  localStorage.setItem('lichSuThu', JSON.stringify(lichSuThu));

  const removeVietnameseTones = (str) =>
    str.normalize('NFD').replace(/[\u0300-\u036f]/g, '')
       .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D');

  const invoice = document.getElementById('invoice');
  const originalHTML = invoice.innerHTML;
  const plainHTML = removeVietnameseTones(originalHTML);

  invoice.style.fontFamily = "'Courier New', monospace";
  invoice.innerHTML = plainHTML;

  setTimeout(()=>{
    window.print();
    invoice.innerHTML = originalHTML;
    invoice.style.fontFamily = "";
  }, 500);
};

// CAMERA qu√©t m√£ KH
let html5QrcodeScanner=null, scannerRunning=false;
btnScan.onclick = ()=>{
  if(scannerRunning){ stopQrScanner(); return; }
  qrReaderDiv.style.display='block';
  Html5Qrcode.getCameras().then(cams=>{
    if(!cams||cams.length===0){ alert('Kh√¥ng t√¨m th·∫•y camera'); qrReaderDiv.style.display='none'; return; }
    html5QrcodeScanner = new Html5Qrcode('qr-reader');
    html5QrcodeScanner.start({deviceId:{exact:cams[0].id}}, {fps:10, qrbox:{width:350,height:250}},
      decodedText=>{
        maKHInput.value = decodedText.trim();
        stopQrScanner();
      }).catch(err=>{
        alert('Kh√¥ng th·ªÉ b·∫≠t camera: '+err);
        qrReaderDiv.style.display='none';
      });
    scannerRunning=true;
  });
};
function stopQrScanner(){
  if(html5QrcodeScanner&&scannerRunning){
    html5QrcodeScanner.stop().then(()=>{ try{ html5QrcodeScanner.clear(); }catch(e){} });
  }
  html5QrcodeScanner=null; scannerRunning=false; qrReaderDiv.style.display='none';
}
window.onbeforeunload=()=>{stopQrScanner();}
</script>
</body>
</html>
