<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>H√≥a ƒë∆°n nh·∫≠n chuy·ªÉn kho·∫£n h·ªô ti·ªÅn ƒëi·ªán</title>

  <!-- Th∆∞ vi·ªán -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root{
      --blue:#2b8cff;
      --green:#28a745;
      --card:#fff;
      --input-radius:10px;
    }
    *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif}
    body{background:#f0f2f7;margin:0;padding:16px;display:flex;justify-content:center}
    .wrap{width:100%;max-width:480px;background:var(--card);border-radius:18px;padding:18px;box-shadow:0 6px 18px rgba(20,20,30,0.06)}
    .btn-primary{background:var(--blue);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:700;display:inline-block;cursor:pointer;box-shadow:0 4px 10px rgba(43,140,255,0.18)}
    .form-row{display:flex;gap:12px;align-items:center;margin-top:12px}
    label{width:120px;font-weight:700;color:#111;font-size:15px}
    input[type=text],input[type=number]{flex:1;padding:12px 14px;border-radius:var(--input-radius);border:1px solid #ccc;font-size:15px;height:48px}
    .half-buttons{display:flex;gap:12px;margin-top:10px}
    .half-buttons button{flex:1;background:var(--blue);color:#fff;border:none;border-radius:var(--input-radius);padding:12px;font-size:16px;font-weight:700;cursor:pointer;height:52px}
    .btn-green{width:100%;background:var(--green);color:#fff;border:none;padding:14px;font-weight:700;border-radius:var(--input-radius);font-size:17px;cursor:pointer;margin-top:14px}
    .invoice{margin-top:14px;border-radius:12px;border:2px solid #111;padding:12px;min-height:120px;background:#fff;font-size:15px;line-height:1.35;position:relative}
    .invoice-header{ text-align:center; font-weight:800; font-size:18px; text-transform:uppercase; margin-bottom:8px; }
    .invoice-date{ position:absolute; top:8px; right:12px; font-size:13px; color:#555; }
    .history{margin-top:12px}
    .history-list{max-height:140px;overflow:auto;border:1px solid #eee;background:#fff;padding:8px;border-radius:8px;font-size:13px}
    #qr-reader{width:100%;margin-top:10px;border-radius:10px;overflow:hidden;display:none; background:#000}
    /* ensure print only invoice */
    @media print {
      body * { visibility: hidden; }
      #invoice, #invoice * { visibility: visible; }
      #invoice { position:absolute; left:0; top:0; width:100%; }
    }
    /* small helper for mobile full-width inputs */
    @media (max-width:420px){
      label{width:110px}
      .wrap{padding:14px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div style="text-align:center"><button class="btn-primary" id="btnLoad">ƒê·∫©y d·ªØ li·ªáu</button></div>

    <!-- Ng∆∞·ªùi thu ti·ªÅn -->
    <div class="form-row">
      <label for="nguoiThu">Ng∆∞·ªùi thu ti·ªÅn</label>
      <input id="nguoiThu" type="text" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi thu">
    </div>

    <!-- M√£ kh√°ch h√†ng -->
    <div class="form-row">
      <label for="maKH">M√£ kh√°ch h√†ng</label>
      <input id="maKH" list="danhSachKH" placeholder="(t√¨m ki·∫øm)">
    </div>

    <!-- Hai n√∫t xu·ªëng d√≤ng, 50/50 -->
    <div class="half-buttons">
      <button id="btnSearch">üîç T√¨m</button>
      <button id="btnScan">üì∑ Qu√©t</button>
    </div>

    <!-- S·ªë ti·ªÅn -->
    <div class="form-row">
      <label for="soTien">S·ªë ti·ªÅn</label>
      <input id="soTien" type="number" placeholder="">
    </div>

    <!-- T√™n KH -->
    <div class="form-row">
      <label for="tenKH">T√™n KH</label>
      <input id="tenKH" type="text" placeholder="" readonly>
    </div>

    <button class="btn-green" id="btnPrint">In h√≥a ƒë∆°n</button>

    <div id="invoice" class="invoice">
      <div class="invoice-date" id="ngayIn"></div>
      <div class="invoice-header">H√ìA ƒê∆†N NH·∫¨N CHUY·ªÇN KHO·∫¢N H·ªò TI·ªÄN ƒêI·ªÜN</div>
      <div id="invoiceContent">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
    </div>

    <div id="qr-reader"></div>

    <div class="history">
      <div style="font-weight:700;margin-bottom:6px">L·ªãch s·ª≠ in</div>
      <div class="history-list" id="historyList"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px">
      <button style="flex:1;background:#f3f3f3;border:none;border-radius:10px;padding:10px" id="btnExportIn">Xu·∫•t l·ªãch s·ª≠ in</button>
      <button style="flex:1;background:#f3f3f3;border:none;border-radius:10px;padding:10px" id="btnExportThu">Xu·∫•t l·ªãch s·ª≠ thu</button>
    </div>

    <button style="width:100%;background:#f3f3f3;border:none;border-radius:10px;padding:10px;margin-top:8px" id="btnExportExcel">Xu·∫•t Excel</button>
    <button style="width:100%;background:#fff;border:1px solid #eee;border-radius:10px;padding:10px;margin-top:8px" id="btnClear">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>

    <input id="fileInput" type="file" accept=".xlsx" style="display:none">
    <datalist id="danhSachKH"></datalist>
  </div>

<script>
  // D·ªØ li·ªáu & l·ªãch s·ª≠
  let duLieu = [];
  let lichSuIn = JSON.parse(localStorage.getItem('lichSuIn') || '[]');
  let lichSuThu = JSON.parse(localStorage.getItem('lichSuThu') || '[]');

  // DOM
  const maKHInput = document.getElementById('maKH');
  const tenKHInput = document.getElementById('tenKH');
  const soTienInput = document.getElementById('soTien');
  const nguoiThuInput = document.getElementById('nguoiThu');
  const invoiceContent = document.getElementById('invoiceContent');
  const historyList = document.getElementById('historyList');
  const btnLoad = document.getElementById('btnLoad');
  const fileInput = document.getElementById('fileInput');
  const btnSearch = document.getElementById('btnSearch');
  const btnScan = document.getElementById('btnScan');
  const btnPrint = document.getElementById('btnPrint');
  const btnConfirm = document.getElementById('btnConfirm');
  const btnExportIn = document.getElementById('btnExportIn');
  const btnExportThu = document.getElementById('btnExportThu');
  const btnExportExcel = document.getElementById('btnExportExcel');
  const btnClear = document.getElementById('btnClear');
  const qrReaderDiv = document.getElementById('qr-reader');
  const ngayIn = document.getElementById('ngayIn');

  // QR scanner vars
  let html5QrcodeScanner = null;
  let scannerRunning = false;
  let scanTimeout = null;

  // Helpers
  function formatVND(n){ return Number(n).toLocaleString('vi-VN') + ' ‚Ç´'; }
  function capNhatLichSu(){
    historyList.innerHTML = '';
    lichSuIn.forEach(i=>{
      const d = document.createElement('div');
      d.textContent = `(${i.thoiGian}) ${i.maKH} - ${i.tenKH}: ${formatVND(i.soTien)}`;
      historyList.appendChild(d);
    });
  }
  function capNhatNgayIn(){
    const now = new Date();
    ngayIn.textContent = 'Ng√†y in: ' + now.toLocaleDateString('vi-VN') + ' ‚Äì ' + now.toTimeString().split(' ')[0];
  }

  capNhatLichSu();
  capNhatNgayIn();

  // Load Excel (ƒê·∫©y d·ªØ li·ªáu)
  btnLoad.onclick = () => fileInput.click();
  fileInput.onchange = docFileExcel;
  function docFileExcel(e){
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
      const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
      const sh = wb.Sheets[wb.SheetNames[0]];
      duLieu = XLSX.utils.sheet_to_json(sh).map(r => ({
        MA_KHTT: String(r.MA_KHTT || r['M√£ KH'] || '').trim().toUpperCase().replace(/(\.0)$/,''),
        TEN_KHTT: String(r.TEN_KHTT || r['T√™n'] || '').trim(),
        TONG_NOP: String(r.TONG_NOP || r['S·ªë ti·ªÅn'] || '').replace(/[^0-9]/g,'')
      }));
      const dl = document.getElementById('danhSachKH'); dl.innerHTML = '';
      duLieu.forEach(r=>{ const o = document.createElement('option'); o.value = r.MA_KHTT; dl.appendChild(o); });
      alert('ƒê·∫©y d·ªØ li·ªáu th√†nh c√¥ng!');
    };
    r.readAsArrayBuffer(f);
  }

  // T√≠nh s·∫£n l∆∞·ª£ng (gi·ªØ logic g·ªëc)
  function tinhSanLuongTuSoTien(soTien){
    const bac=[{s:55,g:1984},{s:52,g:2050},{s:103,g:2380},{s:103,g:2998},{s:103,g:3350},{s:287,g:3460}];
    let tong=0,tien=soTien;
    for(let i of bac){
      const tb = i.s * i.g;
      if(tien>=tb){ tong+=i.s; tien-=tb; } else { tong += Math.floor(tien/i.g); break; }
    }
    return tong;
  }

  // Hi·ªÉn th·ªã h√≥a ƒë∆°n (tr√™n m√†n h√¨nh - c√≥ d·∫•u)
  function hienThiHoaDon(ma, ten, soTien, sanLuong){
    capNhatNgayIn();
    const nguoi = nguoiThuInput.value || '-';
    const phi = 2000;
    const tong = Number(soTien) + phi;
    const now = new Date();
    const tg = `Ng√†y ${now.toLocaleDateString('vi-VN')}, Gi·ªù ${now.toTimeString().split(' ')[0]}`;
    invoiceContent.innerHTML = `
      <div style="text-align:center;font-weight:700;font-size:18px;">THU TI·ªÄN ƒêI·ªÜN</div>
      <p><b>M√£ KH:</b> ${ma}</p>
      <p><b>T√™n KH:</b> ${ten}</p>
      <p><b>∆Ø·ªõc s·∫£n l∆∞·ª£ng:</b> ${sanLuong} kWh</p>
      <p><b>Ph√≠:</b> ${formatVND(phi)}</p>
      <p><b>T·ªïng:</b> ${formatVND(tong)}</p>
      <p><b>Ng∆∞·ªùi thu:</b> ${nguoi}</p>
      <p style="color:green;font-weight:700;text-align:center">ƒê√É NH·∫¨N TI·ªÄN</p>
      <p style="text-align:center">${tg}</p>
      <div id="maQR" style="text-align:center;margin-top:10px;"></div>
    `;
    const qrDiv = document.getElementById('maQR');
    qrDiv.innerHTML = '';
    new QRCode(qrDiv, { text: ma, width: 120, height: 120 });
  }

  // T√¨m KH b·∫±ng √¥ t√¨m
  btnSearch.onclick = ()=>{
    const ma = maKHInput.value.trim().toUpperCase();
    if(!ma){ alert('Nh·∫≠p m√£ kh√°ch h√†ng'); return; }
    const kh = duLieu.find(r=>r.MA_KHTT === ma);
    if(!kh){ alert('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng trong d·ªØ li·ªáu ƒë√£ ƒë·∫©y'); return; }
    tenKHInput.value = kh.TEN_KHTT;
    soTienInput.value = kh.TONG_NOP;
    const san = tinhSanLuongTuSoTien(Number(kh.TONG_NOP));
    hienThiHoaDon(kh.MA_KHTT, kh.TEN_KHTT, Number(kh.TONG_NOP), san);
  };

  // In h√≥a ƒë∆°n: in tr·ª±c ti·∫øp tr√™n trang hi·ªán t·∫°i, ch·ªâ chuy·ªÉn #invoice sang kh√¥ng d·∫•u khi in, sau ƒë√≥ kh√¥i ph·ª•c
  function removeVietnameseTones(str){
    return str.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/ƒê/g,'D');
  }

  btnPrint.onclick = ()=>{
    const ma = maKHInput.value.trim();
    const ten = tenKHInput.value.trim();
    const soTien = Number(soTienInput.value || 0);
    if(!ma || !ten || !soTien){ alert('Nh·∫≠p ƒë·ªß th√¥ng tin tr∆∞·ªõc khi in!'); return; }
    const san = tinhSanLuongTuSoTien(soTien);
    hienThiHoaDon(ma, ten, soTien, san);

    // l∆∞u l·ªãch s·ª≠ tr∆∞·ªõc khi in
    const tong = soTien + 2000;
    const thoiGian = new Date().toLocaleString();
    lichSuIn.push({ maKH: ma, tenKH: ten, soTien: tong, thoiGian });
    lichSuThu.push({ maKH: ma, tenKH: ten, soTien: tong, thoiGian });
    localStorage.setItem('lichSuIn', JSON.stringify(lichSuIn));
    localStorage.setItem('lichSuThu', JSON.stringify(lichSuThu));
    capNhatLichSu();

    // thay invoice th√†nh kh√¥ng d·∫•u t·∫°m th·ªùi
    const invoice = document.getElementById('invoice');
    const originalHTML = invoice.innerHTML;
    invoice.innerHTML = removeVietnameseTones(originalHTML);

    // in tr·ª±c ti·∫øp (kh√¥ng m·ªü c·ª≠a s·ªï m·ªõi)
    setTimeout(()=>{
      window.print();
      // kh√¥i ph·ª•c hi·ªÉn th·ªã c√≥ d·∫•u
      invoice.innerHTML = originalHTML;
    }, 700);
  };

  // X√°c nh·∫≠n ƒë√£ thu (gi·ªØ nguy√™n logic)
  // N·∫øu b·∫°n mu·ªën n√∫t x√°c nh·∫≠n, b·∫≠t l·∫°i ph·∫ßn n√†y (hi·ªán file g·ªëc c√≥ btnConfirm)
  // For now we'll keep the history push on print as original behavior

  // Xu·∫•t CSV / Excel
  function exportCsv(arr, fn){
    const head = 'M√£ KH,T√™n KH,S·ªë ti·ªÅn,Th·ªùi gian\n';
    const rows = arr.map(i=>`${i.maKH},${i.tenKH},${i.soTien},${i.thoiGian}`).join('\n');
    const blob = new Blob([head + rows], { type: 'text/csv' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fn; a.click();
  }
  btnExportIn.onclick = ()=>exportCsv(lichSuIn, 'lich_su_in.csv');
  btnExportThu.onclick = ()=>exportCsv(lichSuThu, 'lich_su_thu.csv');
  btnExportExcel.onclick = ()=>exportCsv([...lichSuIn, ...lichSuThu], 'lich_su_all.csv');
  btnClear.onclick = ()=>{ if(confirm('X√≥a to√†n b·ªô l·ªãch s·ª≠?')){ lichSuIn = []; lichSuThu = []; localStorage.removeItem('lichSuIn'); localStorage.removeItem('lichSuThu'); capNhatLichSu(); } };

  // CAMERA: b·∫≠t khung qu√©t 350x250 d∆∞·ªõi √¥ M√£ KH, t·ª± t·∫Øt sau 30s
  btnScan.onclick = startQrScanner;
  function startQrScanner(){
    if(scannerRunning) return stopQrScanner();
    qrReaderDiv.style.display = 'block';
    Html5Qrcode.getCameras().then(cams=>{
      if(!cams || cams.length === 0){
        alert('‚ö†Ô∏è Tr√¨nh duy·ªát ch∆∞a cho ph√©p camera ho·∫∑c kh√¥ng c√≥ camera.');
        qrReaderDiv.style.display = 'none';
        return;
      }
      html5QrcodeScanner = new Html5Qrcode('qr-reader');
      const camId = cams[0].id;
      html5QrcodeScanner.start(
        { deviceId: { exact: camId } },
        { fps: 10, qrbox: { width: 350, height: 250 } },
        (decodedText, result) => {
          // qu√©t ƒë∆∞·ª£c -> t·ª± ƒëi·ªÅn m√£ KH, hi·ªÉn th·ªã h√≥a ƒë∆°n, t·∫Øt camera
          maKHInput.value = decodedText.trim();
          // t√¨m trong duLieu n·∫øu c√≥
          const kh = duLieu.find(r=>r.MA_KHTT === decodedText.trim());
          if(kh){
            tenKHInput.value = kh.TEN_KHTT;
            soTienInput.value = kh.TONG_NOP;
            const san = tinhSanLuongTuSoTien(Number(kh.TONG_NOP));
            hienThiHoaDon(kh.MA_KHTT, kh.TEN_KHTT, Number(kh.TONG_NOP), san);
          } else {
            // n·∫øu kh√¥ng c√≥ data, ch·ªâ hi·ªán m√£
            hienThiHoaDon(decodedText.trim(), 'Kh√°ch h√†ng', Number(soTienInput.value||0), 0);
          }
          stopQrScanner();
        },
        (errorMessage) => {
          // ignore per-frame errors
        }
      ).catch(err=>{
        alert('‚ö†Ô∏è Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + (err && err.message ? err.message : err));
        qrReaderDiv.style.display = 'none';
      });
      scannerRunning = true;
      // t·ª± t·∫Øt sau 30s
      scanTimeout = setTimeout(()=>{ stopQrScanner(); }, 30000);
    }).catch(err=>{
      alert('‚ö†Ô∏è Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + (err && err.message ? err.message : err));
      qrReaderDiv.style.display = 'none';
    });
  }
  function stopQrScanner(){
    if(html5QrcodeScanner && scannerRunning){
      html5QrcodeScanner.stop().then(()=>{ try{ html5QrcodeScanner.clear(); }catch(e){} });
    }
    html5QrcodeScanner = null;
    scannerRunning = false;
    clearTimeout(scanTimeout);
    qrReaderDiv.style.display = 'none';
  }
  window.onbeforeunload = ()=>{ stopQrScanner(); };

  // Khi ng∆∞·ªùi d√πng t·ª± nh·∫≠p m√£ r·ªìi b·∫•m enter -> t√¨m lu√¥n
  maKHInput.addEventListener('keydown', function(e){
    if(e.key === 'Enter'){ btnSearch.click(); e.preventDefault(); }
  });

</script>
</body>
</html>
