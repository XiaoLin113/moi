<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thu ti·ªÅn ƒëi·ªán</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f0f0f0; font-size: 16px; }
    .container { max-width: 430px; margin: auto; background: #fff; border-radius: 12px; padding: 18px; }
    input, button, textarea { font-size: 16px; margin: 6px 0; padding: 8px; border-radius: 6px; border: 1px solid #ccc; }
    button { background: #4387fd; color: #fff; font-weight: bold; border: none; cursor: pointer; padding: 8px 14px; }
    button:active { background: #3066b2; }
    #hoaDon { border: 1px solid #000; border-radius: 8px; padding: 12px; margin-top: 12px; background: #fafafa; }
    #qr-reader { display:none; margin: 12px auto; max-width: 320px; }
  </style>
</head>
<body>
<div class="container">
  <h2>Thu ti·ªÅn ƒëi·ªán</h2>
  <div>
    <button onclick="document.getElementById('fileInput').click()">ƒê·∫©y d·ªØ li·ªáu Excel</button>
    <input type="file" id="fileInput" style="display:none" accept=".xls,.xlsx" onchange="docFileExcel(event)">
  </div>
  <div>
    <label>Ng∆∞·ªùi thu ti·ªÅn:</label>
    <input id="nguoiThuTien" placeholder="T√™n ng∆∞·ªùi thu">
  </div>
  <div>
    <label>M√£ KH:</label>
    <input id="maKH" list="danhSachKH" placeholder="Nh·∫≠p ho·∫∑c qu√©t m√£">
    <datalist id="danhSachKH"></datalist>
    <button onclick="timKiemMaKH()">üîç</button>
    <button onclick="batDauQuetQR()">üì∑</button>
  </div>
  <div id="qr-reader"></div>
  <div>
    <label>S·ªë ti·ªÅn:</label>
    <input id="soTien" readonly>
  </div>
  <div>
    <label>T√™n KH:</label>
    <input id="tenKH" readonly>
  </div>

  <div id="hoaDon">
    <div id="hoaDonText">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
    <div id="qrCodeArea" style="text-align:center;margin-top:10px;"></div>
  </div>

  <div style="margin-top:12px;">
    <button onclick="inHoaDon()">In</button>
    <button onclick="xacNhanThu()" style="border:1px solid #000;">X√°c nh·∫≠n ƒë√£ thu</button>
  </div>

  <div style="margin-top:14px;">
    <label>L·ªãch s·ª≠ in</label>
    <textarea id="lichSuIn" readonly></textarea>
    <label>L·ªãch s·ª≠ thu</label>
    <textarea id="lichSuThu" readonly></textarea>
    <div>
      <button onclick="xuatLichSu('in')">Xu·∫•t l·ªãch s·ª≠ in</button>
      <button onclick="xuatLichSu('thu')">Xu·∫•t l·ªãch s·ª≠ thu</button>
    </div>
  </div>
</div>

<script>
let duLieu = [], lichSuIn = JSON.parse(localStorage.getItem('lichSuIn')||'[]'), lichSuThu = JSON.parse(localStorage.getItem('lichSuThu')||'[]');
const phiCoDinh = 2000;

function formatVND(n){ return Number(n).toLocaleString('vi-VN')+' ‚Ç´'; }

// ƒê·ªçc file Excel
function docFileExcel(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];
    duLieu = XLSX.utils.sheet_to_json(sheet).map(row => {
      let ma = String(row.MA_KHTT || row.MA || row["M√£ KH"] || "").trim();
      ma = ma.replace(/\\.0$/,"").toUpperCase();
      let ten = String(row.TEN_KHTT || row.TEN || row["T√™n KH"] || "").trim();
      let tong = String(row.TONG_NOP || row.TIEN || row["S·ªë ti·ªÅn"] || "").replace(/[^0-9]/g,"");
      return { MA_KHTT: ma, TEN_KHTT: ten, TONG_NOP: tong };
    });
    // C·∫≠p nh·∫≠t datalist
    const dataList = document.getElementById("danhSachKH");
    dataList.innerHTML = "";
    duLieu.forEach(r=>{
      const op = document.createElement("option");
      op.value = r.MA_KHTT;
      dataList.appendChild(op);
    });
    alert("ƒê·∫©y d·ªØ li·ªáu th√†nh c√¥ng!");
  };
  reader.readAsArrayBuffer(file);
}

// T√¨m m√£ KH
function timKiemMaKH(){
  const ma = document.getElementById('maKH').value.trim().toUpperCase();
  const kh = duLieu.find(r => r.MA_KHTT === ma);
  if(!kh){ document.getElementById('hoaDonText').textContent = '[Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng]'; return; }
  document.getElementById('tenKH').value = kh.TEN_KHTT;
  document.getElementById('soTien').value = kh.TONG_NOP;
  hienThiHoaDon(ma, kh.TEN_KHTT, kh.TONG_NOP);
}

// Hi·ªÉn th·ªã h√≥a ƒë∆°n
function hienThiHoaDon(ma, ten, so){
  const nguoi = document.getElementById('nguoiThuTien').value || '-';
  const tong = Number(so) + phiCoDinh;
  const now = new Date();
  const txt = `BI√äN LAI NH·∫¨N TI·ªÄN CHUY·ªÇN KHO·∫¢N

M√£ KH: ${ma}
T√™n KH: ${ten}
T·ªïng ti·ªÅn: ${formatVND(tong)}
Ng∆∞·ªùi thu ti·ªÅn: ${nguoi}

ƒê√É NH·∫¨N TI·ªÄN
Ng√†y ${now.toLocaleDateString('vi-VN')}, Gi·ªù ${now.toTimeString().slice(0,8)}`;

  document.getElementById('hoaDonText').textContent = txt;
  const qrArea = document.getElementById('qrCodeArea');
  qrArea.innerHTML = '';
  new QRCode(qrArea, { text: ma, width: 128, height: 128 });
}

// In h√≥a ƒë∆°n b·∫±ng ·∫£nh
async function inHoaDon(){
  const hoaDonDiv = document.getElementById("hoaDon");
  const canvas = await html2canvas(hoaDonDiv, { scale: 3, useCORS: true });
  const imgData = canvas.toDataURL("image/png");

  // l∆∞u l·ªãch s·ª≠ in
  const ma=document.getElementById('maKH').value,
        ten=document.getElementById('tenKH').value,
        so=Number(document.getElementById('soTien').value||0)+phiCoDinh;
  lichSuIn.push({maKH:ma,tenKH:ten,soTien:so,thoiGian:new Date().toLocaleString()});
  localStorage.setItem('lichSuIn',JSON.stringify(lichSuIn));

  const win = window.open("", "_blank");
  win.document.write(`
    <html><head><title>In</title>
    <style>body{text-align:center;margin:0} img{width:58mm;max-width:100%}</style>
    </head><body>
    <img src="${imgData}" />
    <script>window.onload=function(){window.print();setTimeout(()=>window.close(),500);}</script>
    </body></html>
  `);
  win.document.close();
}

// X√°c nh·∫≠n thu
function xacNhanThu(){
  const ma=document.getElementById('maKH').value, ten=document.getElementById('tenKH').value;
  const so=Number(document.getElementById('soTien').value||0)+phiCoDinh;
  lichSuThu.push({maKH:ma,tenKH:ten,soTien:so,thoiGian:new Date().toLocaleString()});
  localStorage.setItem('lichSuThu',JSON.stringify(lichSuThu));
}

// Xu·∫•t l·ªãch s·ª≠
function xuatLichSu(loai){
  const arr=loai==='in'?lichSuIn:lichSuThu;
  const txt=arr.map(i=>`(${i.thoiGian}) ${i.maKH}-${i.tenKH}: ${i.soTien}`).join('\\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([txt],{type:'text/plain'}));
  a.download=\`lich_su_\${loai}.txt\`;
  a.click();
}

// QR code scanner
let html5QrCode;
function batDauQuetQR(){
  const region=document.getElementById('qr-reader');region.style.display='block';
  if(!html5QrCode)html5QrCode=new Html5Qrcode('qr-reader');
  html5QrCode.start({facingMode:'environment'},{fps:10,qrbox:250},
    msg=>{document.getElementById('maKH').value=msg;region.style.display='none';html5QrCode.stop();timKiemMaKH();},
    err=>{})
  .catch(()=>{alert('Kh√¥ng m·ªü ƒë∆∞·ª£c camera');region.style.display='none';});
}
</script>
</body>
</html>
